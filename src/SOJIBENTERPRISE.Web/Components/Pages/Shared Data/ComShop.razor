@page "/Shop"

@rendermode @(new InteractiveServerRenderMode(prerender: false))
@inject DialogService DialogService

<Message @ref="notificationComponent" />

<h3>Shop</h3>

@if (ShopList == null)
{
    <p><em>Loading...</em></p>
}
else
{
    <div class="card-body p-0">
        <RadzenButton Click="@AddNew" Text="Add New" ButtonStyle="ButtonStyle.Success"></RadzenButton>

        <RadzenDataGrid Data="@ShopList" TItem="Shop" PageSize="10" AllowPaging="true" AllowSorting="true" AllowFiltering="false">
            <Columns>
                <RadzenDataGridColumn TItem="Shop" Property="@nameof(Shop.Name)" Title="Shop Name" Width="100px" />
                <RadzenDataGridColumn TItem="Shop" Property="@nameof(Shop.ShopOwner)" Title="Owner Name" Width="100px" />
                <RadzenDataGridColumn TItem="Shop" Property="@nameof(Shop.Number)" Title="Number" Width="100px" />
                <RadzenDataGridColumn TItem="Shop" Property="@nameof(Shop.Area)" Title="Area" Width="200px" />
                <RadzenDataGridColumn TItem="Shop" Property="@nameof(Shop.Description)" Title="Description" Width="150px" />
                <RadzenDataGridColumn TItem="Shop" Title="Deleted" Width="80px">
                    <Template Context="item">
                        @{
                            bool isDisabled = item.IsDeleted == true;
                            string text = isDisabled ? "Yes" : "No";
                            string badgeColor = isDisabled ? "badge bg-danger" : "badge bg-primary"; // Blue for Yes, Red for No
                        }
                        <span class="@badgeColor">@text</span>
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="Shop" Title="Actions" Width="60px">
                    <Template Context="context">
                        <RadzenButton Icon="edit" ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Small"
                                      Click="() => Edit(context.Id)" style="margin-right: 5px;" title="Edit" />
                        <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.Small"
                                      Click="() => ConfirmDelete(context.Id)" title="Delete" />
                    </Template>
                </RadzenDataGridColumn>
            </Columns>
        </RadzenDataGrid>
    </div>
}

@if (showModal)
{
    <div class="modal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="1" style="display:block">
        <div class="modal-dialog modal-lg modal-dialog-scrollable modal-dialog-centered">
            <div class="modal-content card dataFormPop">
                <div class="modal-header">
                    <h3>@(Shop.Id > 0 ? "Edit Shop" : "Add Shop")</h3>
                </div>

                <EditForm Model="@Shop" OnValidSubmit="HandleSubmit">
                    <div class="card dataForm ">
                        <div class="row m-3">
                            <div class="col-md-4 mb-3">
                                <label class="Asterisk">Name</label>
                                <InputText @bind-Value="Shop.Name" class="form-control"></InputText>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="Asterisk">Owner Name</label>
                                <InputText @bind-Value="Shop.ShopOwner" class="form-control"></InputText>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="Asterisk">Number</label>
                                <InputText @bind-Value="Shop.Number" class="form-control"></InputText>
                            </div>
                            </div>
                        <div class="row m-3">
                            <div class="col-md-4 mb-3">
                                <label class="Asterisk">Area</label>
                                <InputText @bind-Value="Shop.Area" class="form-control"></InputText>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label>Comments</label>
                                <InputText @bind-Value="Shop.Description" class="form-control"></InputText>
                            </div>
                            @if (Shop.Id > 0)
                            {
                                <div class="col-md-4 mb-3">
                                    <div class="form-check mb-3 pt-4">
                                        <InputCheckbox @bind-Value="Shop.IsDeleted" class="form-check-input custom-checkbox-lg" id="disableCheck" />
                                        <label class="form-check-label" for="disableCheck">Deleted</label>
                                    </div>
                                </div>
                            }
                        </div>
                        <br />
                        <div class="col-md-12">
                            <RadzenButton Text="Save" ButtonStyle="ButtonStyle.Primary" Type="submit" Class="m-2" />
                            <RadzenButton Text="Cancel" ButtonStyle="ButtonStyle.Secondary" Click="CloseModal" Class="m-2" />
                        </div>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
}

@code {
    [Inject]
    private ILookup m_Lookup { get; set; }

    [Inject]
    private NavigationManager _navigationManager { get; set; }

    public IEnumerable<Shop> ShopList { get; set; } = new List<Shop>();

    private bool showModal = false;

    public Shop Shop { get; set; }
    private Message notificationComponent;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task HandleSubmit()
    {
        if (string.IsNullOrWhiteSpace(Shop.Name))
        {
            notificationComponent.Show("Validation Summary", "Shop name is required.", NotificationSeverity.Warning);
            return;
        }


        showModal = false;

        if (Shop.Id > 0)
        {
            m_Lookup.UpdateShop(Shop);
            notificationComponent.Show("Updated Summary", "Shop has been Updated successfully", NotificationSeverity.Warning);
        }
        else
        {
            m_Lookup.CreateShop(Shop);
            notificationComponent.Show("Added Summary", "Shop has been Added successfully", NotificationSeverity.Success);
        }

        await LoadData();
        StateHasChanged();
    }

    private void Edit(int id)
    {
        showModal = true;

        if (id > 0)
        {
            Shop = m_Lookup.GetShop(id);
        }
        else
        {
            Shop = new Shop()
            {
            };
        }
    }

    async Task ConfirmDelete(int id)
    {
        var options = new ConfirmOptions()
            {
                OkButtonText = "Yes, Delete",
                CancelButtonText = "No, Keep",
                ShowClose = true,
            };

        bool? confirmed = await DialogService.Confirm("Are you absolutely sure you want to delete this item?", "Delete Confirmation", options);

        if (confirmed == true)
        {
            await Delete(id);
        }
    }

    async Task Delete(int id)
    {
        bool isDeleted = m_Lookup.DeleteShop(id);
        if (isDeleted)
        {
            notificationComponent.Show("Delete Summary", "Shop has been Deleted successfully", NotificationSeverity.Error);
        }else
        {
            notificationComponent.Show("Delete Summary", "The shop could not be deleted because it is already linked to other entity.", NotificationSeverity.Error);
        }

        await LoadData();
        StateHasChanged(); // If you are managing the data source manually
    }


    private void AddNew()
    {
        Shop = new Shop()
            {
            };
        showModal = true;
    }

    private async Task LoadData()
    {
        ShopList = await m_Lookup.GetAllShop();
    }

    private void CloseModal()
    {
        showModal = false;
    }
}